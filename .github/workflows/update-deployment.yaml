name: Update Deployment Image

on:
  workflow_run:
    workflows: ["Boardgame"]   # Must match the name of the first workflow
    types:
      - completed

jobs:
  update-deployment:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Docker image tag artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image-tag
        path: .

    - name: Update deployment.yaml image
      run: |
        IMAGE_NAME=hacked01/boardgame
        IMAGE_TAG=$(cat docker-image.txt)
        DEPLOYMENT_FILE=deployment.yaml

        # Replace the image line in deployment.yaml
        sed -i "s|image: .*|image: $IMAGE_NAME:$IMAGE_TAG|g" $DEPLOYMENT_FILE

        echo "Updated deployment.yaml:"
        cat $DEPLOYMENT_FILE

    - name: Commit and push updated deployment.yaml
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add deployment.yaml
        git commit -m "Update deployment image to $IMAGE_TAG"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
